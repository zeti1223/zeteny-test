<!doctype html>
<html lang="hu">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Firebase Chat</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      :root {
        --primary-color: #6c5ce7;
        --secondary-color: #a29bfe;
        --accent-color: #fd79a8;
        --text-color: #2d3436;
        --bg-color: #f9f9f9;
        --card-bg: #ffffff;
        --border-color: #e0e0e0;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        --success-color: #00b894;
        --error-color: #d63031;
        --gradient: linear-gradient(
          135deg,
          var(--primary-color),
          var(--secondary-color)
        );
      }

      .dark-mode {
        --primary-color: #6c5ce7;
        --secondary-color: #a29bfe;
        --text-color: #f5f6fa;
        --bg-color: #1e272e;
        --card-bg: #2d3436;
        --border-color: #353b48;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        transition:
          background-color 0.3s,
          color 0.3s;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: var(--bg-color);
        color: var(--text-color);
        max-height: 100vh;
        display: flex;
        flex-direction: column;
        background-image:
          radial-gradient(
            circle at 10% 20%,
            rgba(108, 92, 231, 0.1) 0%,
            transparent 20%
          ),
          radial-gradient(
            circle at 90% 80%,
            rgba(162, 155, 254, 0.1) 0%,
            transparent 20%
          );
      }

      header {
        background: var(--gradient);
        color: white;
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: var(--shadow);
      }

      .logo {
        font-size: 1.8rem;
        font-weight: bold;
        display: flex;
        align-items: center;
      }

      .logo i {
        margin-right: 0.5rem;
      }

      .header-controls {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .theme-toggle,
      .logout-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2rem;
        transition: all 0.3s;
      }

      .theme-toggle:hover,
      .logout-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.05);
      }

      .container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 1rem;
        display: flex;
        flex: 1;
        gap: 1.5rem;
      }

      .sidebar {
        flex: 0 0 280px;
        background: var(--card-bg);
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
        max-height: 75vh;
      }

      .main-content {
        flex: 1;
        background: var(--card-bg);
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
        max-height: 75vh;
      }

      .user-info {
        display: flex;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--border-color);
      }

      .avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: var(--gradient);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 1.2rem;
        margin-right: 0.8rem;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }

      .user-details {
        flex: 1;
      }

      .user-details .username {
        font-weight: 600;
        margin-bottom: 0.2rem;
      }

      .user-details .email {
        font-size: 0.8rem;
        opacity: 0.7;
      }

      .tabs {
        display: flex;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid var(--border-color);
      }

      .tab {
        padding: 0.7rem 1.2rem;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        font-weight: 500;
        transition: all 0.3s;
      }

      .tab.active {
        border-bottom: 3px solid var(--primary-color);
        color: var(--primary-color);
      }

      .tab:hover {
        background-color: rgba(108, 92, 231, 0.1);
      }

      .tab-content {
        display: none;
        flex: 1;
        overflow-y: auto;
      }

      .tab-content.active {
        display: block;
      }

      .room-list,
      .user-list {
        list-style: none;
        margin-top: 0.5rem;
      }

      .room-item,
      .user-item {
        padding: 0.9rem;
        border-radius: 10px;
        margin-bottom: 0.7rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        transition: all 0.3s;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }

      .room-item:hover,
      .user-item:hover {
        background-color: rgba(108, 92, 231, 0.1);
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }

      .room-item i,
      .user-item i {
        margin-right: 0.7rem;
        color: var(--primary-color);
        font-size: 1.1rem;
      }

      .create-room-btn {
        background: var(--gradient);
        color: white;
        border: none;
        border-radius: 10px;
        padding: 0.8rem 1.2rem;
        cursor: pointer;
        margin-top: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        transition: all 0.3s;
        box-shadow: 0 4px 10px rgba(108, 92, 231, 0.3);
      }

      .create-room-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(108, 92, 231, 0.4);
      }

      .create-room-btn i {
        margin-right: 0.7rem;
      }

      .chat-header {
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        font-size: 1.2rem;
        font-weight: 600;
      }

      .chat-header i {
        margin-right: 0.7rem;
        color: var(--primary-color);
      }

      .messages {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 1.5rem;
        padding: 1rem;
        border-radius: 10px;
        background-color: rgba(0, 0, 0, 0.03);
        max-height: 60vh;
      }

      .dark-mode .messages {
        background-color: rgba(255, 255, 255, 0.05);
      }

      .message {
        margin-bottom: 1.2rem;
        padding: 1rem;
        border-radius: 15px;
        background: var(--card-bg);
        box-shadow: var(--shadow);
        max-width: 80%;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message.own {
        margin-left: auto;
        background: var(--gradient);
        color: white;
      }

      .message-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        font-size: 0.8rem;
        opacity: 0.8;
      }

      .message-input {
        display: flex;
        margin-top: auto;
        gap: 0.5rem;
      }

      .message-input input {
        flex: 1;
        padding: 1rem;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        background: var(--card-bg);
        color: var(--text-color);
        font-size: 1rem;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }

      .message-input input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(108, 92, 231, 0.2);
      }

      .message-input button {
        padding: 1rem 1.5rem;
        background: var(--gradient);
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
        box-shadow: 0 4px 10px rgba(108, 92, 231, 0.3);
      }

      .message-input button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(108, 92, 231, 0.4);
      }

      .auth-container {
        max-width: 450px;
        margin: 3rem auto;
        padding: 2.5rem;
        background: var(--card-bg);
        border-radius: 20px;
        box-shadow: var(--shadow);
        position: relative;
        overflow: hidden;
      }

      .auth-container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 5px;
        background: var(--gradient);
      }

      .auth-tabs {
        display: flex;
        margin-bottom: 2rem;
        background: rgba(108, 92, 231, 0.1);
        border-radius: 10px;
        padding: 5px;
      }

      .auth-tab {
        flex: 1;
        text-align: center;
        padding: 0.8rem;
        cursor: pointer;
        border-radius: 8px;
        transition: all 0.3s;
        font-weight: 500;
      }

      .auth-tab.active {
        background: var(--gradient);
        color: white;
        box-shadow: 0 4px 10px rgba(108, 92, 231, 0.3);
      }

      .auth-form {
        display: none;
      }

      .auth-form.active {
        display: block;
        animation: fadeIn 0.5s ease;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.7rem;
        font-weight: 500;
      }

      .form-group input {
        width: 100%;
        padding: 1rem;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        background: var(--card-bg);
        color: var(--text-color);
        font-size: 1rem;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }

      .form-group input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(108, 92, 231, 0.2);
      }

      .auth-btn {
        width: 100%;
        padding: 1rem;
        background: var(--gradient);
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        margin-top: 0.5rem;
        font-weight: 600;
        font-size: 1rem;
        transition: all 0.3s;
        box-shadow: 0 4px 10px rgba(108, 92, 231, 0.3);
      }

      .auth-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(108, 92, 231, 0.4);
      }

      .error-message {
        color: var(--error-color);
        margin-top: 1rem;
        font-size: 0.9rem;
        text-align: center;
        padding: 0.7rem;
        border-radius: 8px;
        background-color: rgba(214, 48, 49, 0.1);
      }

      .success-message {
        color: var(--success-color);
        margin-top: 1rem;
        font-size: 0.9rem;
        text-align: center;
        padding: 0.7rem;
        border-radius: 8px;
        background-color: rgba(0, 184, 148, 0.1);
      }

      footer {
        text-align: center;
        padding: 1.5rem;
        margin-top: auto;
        background: var(--card-bg);
        border-top: 1px solid var(--border-color);
      }

      /* Modal stílusok */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s;
      }

      .modal-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      .modal {
        background: var(--card-bg);
        border-radius: 15px;
        padding: 2rem;
        width: 90%;
        max-width: 450px;
        box-shadow: var(--shadow);
        transform: translateY(-20px);
        transition: all 0.3s;
      }

      .modal-overlay.active .modal {
        transform: translateY(0);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
      }

      .modal-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--primary-color);
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-color);
      }

      .modal-body {
        margin-bottom: 1.5rem;
      }

      .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
      }

      .modal-btn {
        padding: 0.7rem 1.5rem;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
      }

      .modal-btn.primary {
        background: var(--gradient);
        color: white;
        border: none;
        box-shadow: 0 4px 10px rgba(108, 92, 231, 0.3);
      }

      .modal-btn.secondary {
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-color);
      }

      .modal-btn:hover {
        transform: translateY(-2px);
      }

      .modal-btn.primary:hover {
        box-shadow: 0 6px 15px rgba(108, 92, 231, 0.4);
      }

      .dm-indicator {
        background-color: rgba(253, 121, 168, 0.1);
        border-left: 3px solid var(--accent-color);
      }

      .dm-indicator i {
        color: var(--accent-color) !important;
      }

      @media (max-width: 768px) {
        .container {
          flex-direction: column;
        }

        .sidebar {
          flex: 0;
          margin-bottom: 1.5rem;
        }

        .auth-container {
          margin: 1.5rem;
          padding: 1.5rem;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="logo"><i class="fas fa-comments"></i> Firebase Chat</div>
      <div class="header-controls">
        <button class="theme-toggle" id="themeToggle">
          <i class="fas fa-moon"></i>
        </button>
        <button class="logout-btn" id="logoutBtn" style="display: none">
          <i class="fas fa-sign-out-alt"></i>
        </button>
      </div>
    </header>
    <div class="container" id="mainContainer" style="display: none">
      <div class="sidebar">
        <div class="user-info">
          <div class="avatar" id="userAvatar">U</div>
          <div class="user-details">
            <div class="username" id="usernameDisplay">Felhasználó</div>
            <div class="email" id="userEmail"></div>
          </div>
        </div>

        <div class="tabs">
          <div class="tab active" data-tab="rooms">Szobák</div>
          <div class="tab" data-tab="users">Felhasználók</div>
        </div>

        <div class="tab-content active" id="roomsTab">
          <h3>Chat Szobák</h3>
          <ul class="room-list" id="roomList">
            <!-- Szobák listája -->
          </ul>
          <button class="create-room-btn" id="createRoomBtn">
            <i class="fas fa-plus"></i> Új szoba
          </button>
        </div>

        <div class="tab-content" id="usersTab">
          <h3>Online Felhasználók</h3>
          <ul class="user-list" id="userList">
            <!-- Felhasználók listája -->
          </ul>
        </div>
      </div>

      <div class="main-content">
        <div class="chat-header">
          <i class="fas fa-hashtag"></i>
          <span id="currentChat">Válassz egy szobát</span>
        </div>

        <div class="messages" id="messages">
          <div class="message">
            <div class="message-header">
              <span class="sender">Rendszer</span>
              <span class="time">12:00</span>
            </div>
            <div class="message-content">
              Üdvözöllek a chatben! Válassz egy szobát a bal oldalon.
            </div>
          </div>
        </div>

        <div class="message-input">
          <input type="text" id="messageInput" placeholder="Írj üzenetet..." />
          <button id="sendMessageBtn">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>

    <div class="auth-container" id="authContainer">
      <div class="auth-tabs">
        <div class="auth-tab active" data-form="login">Bejelentkezés</div>
        <div class="auth-tab" data-form="register">Regisztráció</div>
      </div>

      <div class="auth-form active" id="loginForm">
        <div class="form-group">
          <label for="loginEmail">Email cím</label>
          <input
            type="email"
            id="loginEmail"
            placeholder="Add meg az email címed"
          />
        </div>
        <div class="form-group">
          <label for="loginPassword">Jelszó</label>
          <input
            type="password"
            id="loginPassword"
            placeholder="Add meg a jelszavad"
          />
        </div>
        <button class="auth-btn" id="loginBtn">Bejelentkezés</button>
        <div class="error-message" id="loginError"></div>
      </div>

      <div class="auth-form" id="registerForm">
        <div class="form-group">
          <label for="registerUsername">Felhasználónév</label>
          <input
            type="text"
            id="registerUsername"
            placeholder="Válassz felhasználónevet"
          />
        </div>
        <div class="form-group">
          <label for="registerEmail">Email cím</label>
          <input
            type="email"
            id="registerEmail"
            placeholder="Add meg az email címed"
          />
        </div>
        <div class="form-group">
          <label for="registerPassword">Jelszó</label>
          <input
            type="password"
            id="registerPassword"
            placeholder="Válassz erős jelszót"
          />
        </div>
        <div class="form-group">
          <label for="registerPasswordConfirm">Jelszó megerősítése</label>
          <input
            type="password"
            id="registerPasswordConfirm"
            placeholder="Írd be újra a jelszót"
          />
        </div>
        <button class="auth-btn" id="registerBtn">Regisztráció</button>
        <div class="error-message" id="registerError"></div>
        <div class="success-message" id="registerSuccess"></div>
      </div>
    </div>

    <!-- Modal új szoba létrehozásához -->
    <div class="modal-overlay" id="createRoomModal">
      <div class="modal">
        <div class="modal-header">
          <h2 class="modal-title">Új chat szoba</h2>
          <button class="modal-close" id="closeModal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="roomName">Szoba neve</label>
            <input
              type="text"
              id="roomName"
              placeholder="Add meg a szoba nevét"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button class="modal-btn secondary" id="cancelCreateRoom">
            Mégse
          </button>
          <button class="modal-btn primary" id="confirmCreateRoom">
            Létrehozás
          </button>
        </div>
      </div>
    </div>

    <div class="modal-overlay" id="changePasswordModal">
      <div class="modal">
        <div class="modal-header">
          <h2 class="modal-title">Jelszó változtatás</h2>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="currentPassword">Jelenlegi jelszó</label>
            <input
              type="password"
              id="currentPassword"
              placeholder="Add meg a jelenlegi jelszavad"
            />
          </div>
          <div class="form-group">
            <label for="newPassword">Új jelszó</label>
            <input
              type="password"
              id="newPassword"
              placeholder="Add meg az új jelszavad"
            />
          </div>
          <div class="form-group">
            <label for="confirmNewPassword">Új jelszó megerősítése</label>
            <input
              type="password"
              id="confirmNewPassword"
              placeholder="Írd be újra az új jelszót"
            />
          </div>
          <div class="error-message" id="changePasswordError"></div>
          <div class="success-message" id="changePasswordSuccess"></div>
        </div>
        <div class="modal-footer">
          <button class="modal-btn secondary" id="cancelChangePassword">
            Mégse
          </button>
          <button class="modal-btn primary" id="confirmChangePassword">
            Mentés
          </button>
        </div>
      </div>
    </div>

    <footer>Firebase Chat App &copy; 2023 | Created with ❤️</footer>

    <script>
      // Firebase konfiguráció inicializálása
      const firebaseConfig = {
        apiKey: "AIzaSyDn1OTmejSt3k705cFoNFVaN0lX-t0sxlo",
        authDomain: "zeteny-test.firebaseapp.com",
        databaseURL:
          "https://zeteny-test-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "zeteny-test",
        storageBucket: "zeteny-test.firebasestorage.app",
        messagingSenderId: "1048302485508",
        appId: "1:1048302485508:web:15f9180a68b97faee97551",
        measurementId: "G-E3H84LKM0D",
      };

      // Firebase inicializálása
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();

      // DOM elemek
      const themeToggle = document.getElementById("themeToggle");
      const logoutBtn = document.getElementById("logoutBtn");
      const mainContainer = document.getElementById("mainContainer");
      const authContainer = document.getElementById("authContainer");
      const loginForm = document.getElementById("loginForm");
      const registerForm = document.getElementById("registerForm");
      const loginBtn = document.getElementById("loginBtn");
      const registerBtn = document.getElementById("registerBtn");
      const loginError = document.getElementById("loginError");
      const registerError = document.getElementById("registerError");
      const registerSuccess = document.getElementById("registerSuccess");
      const userAvatar = document.getElementById("userAvatar");
      const usernameDisplay = document.getElementById("usernameDisplay");
      const userEmail = document.getElementById("userEmail");
      const roomList = document.getElementById("roomList");
      const userList = document.getElementById("userList");
      const messagesContainer = document.getElementById("messages");
      const messageInput = document.getElementById("messageInput");
      const sendMessageBtn = document.getElementById("sendMessageBtn");
      const currentChat = document.getElementById("currentChat");
      const createRoomBtn = document.getElementById("createRoomBtn");
      const createRoomModal = document.getElementById("createRoomModal");
      const roomNameInput = document.getElementById("roomName");
      const confirmCreateRoom = document.getElementById("confirmCreateRoom");
      const cancelCreateRoom = document.getElementById("cancelCreateRoom");
      const closeModal = document.getElementById("closeModal");
      const tabs = document.querySelectorAll(".tab");
      const authTabs = document.querySelectorAll(".auth-tab");

      // Alkalmazás állapota
      let currentUser = null;
      let currentRoom = null;
      let isDarkMode = localStorage.getItem("darkMode") === "true";
      let dmRooms = {}; // DM szobák tárolása

      // Témaváltás kezelése
      function toggleTheme() {
        isDarkMode = !isDarkMode;
        localStorage.setItem("darkMode", isDarkMode.toString());
        updateTheme();
      }

      function updateTheme() {
        if (isDarkMode) {
          document.body.classList.add("dark-mode");
          themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
        } else {
          document.body.classList.remove("dark-mode");
          themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
        }
      }

      // Modal kezelése
      function openCreateRoomModal() {
        createRoomModal.classList.add("active");
        roomNameInput.value = "";
      }

      function closeCreateRoomModal() {
        createRoomModal.classList.remove("active");
      }

      // Jelszó hash-elése (egyszerű SHA-256 implementáció)
      async function hashPassword(password) {
        const encoder = new TextEncoder();
        const data = encoder.encode(password);
        const hash = await crypto.subtle.digest("SHA-256", data);
        return Array.from(new Uint8Array(hash))
          .map((b) => b.toString(16).padStart(2, "0"))
          .join("");
      }

      // Regisztráció
      async function register(username, email, password, confirmPassword) {
        if (password !== confirmPassword) {
          registerError.textContent = "A jelszavak nem egyeznek!";
          return false;
        }

        if (password.length < 6) {
          registerError.textContent =
            "A jelszónak legalább 6 karakter hosszúnak kell lennie!";
          return false;
        }

        // Email validáció
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          registerError.textContent = "Érvénytelen email cím!";
          return false;
        }

        try {
          const hashedPassword = await hashPassword(password);

          // Ellenőrizzük, hogy a felhasználónév már foglalt-e
          const userRef = database.ref("chat/users");
          const snapshot = await userRef
            .orderByChild("username")
            .equalTo(username)
            .once("value");

          if (snapshot.exists()) {
            registerError.textContent = "A felhasználónév már foglalt!";
            return false;
          }

          // Ellenőrizzük, hogy az email már foglalt-e
          const emailSnapshot = await userRef
            .orderByChild("email")
            .equalTo(email)
            .once("value");

          if (emailSnapshot.exists()) {
            registerError.textContent = "Az email cím már használatban van!";
            return false;
          }

          // Új felhasználó létrehozása
          const newUserRef = userRef.push();
          await newUserRef.set({
            username: username,
            email: email,
            password: hashedPassword,
            createdAt: Date.now(),
          });

          registerError.textContent = "";
          registerSuccess.textContent = "Sikeres regisztráció!";

          // Automatikus bejelentkezés
          return {
            id: newUserRef.key,
            username: username,
            email: email,
          };
        } catch (error) {
          console.error("Regisztrációs hiba:", error);
          registerError.textContent = "Hiba történt a regisztráció során.";
          return false;
        }
      }

      // Bejelentkezés
      async function login(email, password) {
        try {
          const hashedPassword = await hashPassword(password);

          const userRef = database.ref("chat/users");
          const snapshot = await userRef
            .orderByChild("email")
            .equalTo(email)
            .once("value");

          if (!snapshot.exists()) {
            loginError.textContent = "Hibás email vagy jelszó!";
            return false;
          }

          let userData = null;
          snapshot.forEach((child) => {
            if (child.val().password === hashedPassword) {
              userData = {
                id: child.key,
                username: child.val().username,
                email: child.val().email,
              };
            }
          });

          if (!userData) {
            loginError.textContent = "Hibás email vagy jelszó!";
            return false;
          }

          loginError.textContent = "";
          return userData;
        } catch (error) {
          console.error("Bejelentkezési hiba:", error);
          loginError.textContent = "Hiba történt a bejelentkezés során.";
          return false;
        }
      }

      // Felhasználói munkamenet kezelése
      function setUserSession(userData) {
        currentUser = userData;
        localStorage.setItem("currentUser", JSON.stringify(currentUser));

        // UI frissítése
        authContainer.style.display = "none";
        mainContainer.style.display = "flex";
        logoutBtn.style.display = "block";
        userAvatar.textContent = currentUser.username.charAt(0).toUpperCase();
        usernameDisplay.textContent = currentUser.username;
        userEmail.textContent = currentUser.email;

        // Adatok betöltése
        loadRooms();
        loadUsers();
      }

      // Kijelentkezés
      function logout() {
        currentUser = null;
        currentRoom = null;
        localStorage.removeItem("currentUser");

        // UI frissítése
        mainContainer.style.display = "none";
        authContainer.style.display = "block";
        logoutBtn.style.display = "none";
        messagesContainer.innerHTML = `
                <div class="message">
                    <div class="message-header">
                        <span class="sender">Rendszer</span>
                        <span class="time">12:00</span>
                    </div>
                    <div class="message-content">Üdvözöllek a chatben! Válassz egy szobát a bal oldalon.</div>
                </div>
            `;
        currentChat.textContent = "Válassz egy szobát";

        // Űrlapok resetelése
        document.getElementById("loginEmail").value = "";
        document.getElementById("loginPassword").value = "";
        document.getElementById("registerUsername").value = "";
        document.getElementById("registerEmail").value = "";
        document.getElementById("registerPassword").value = "";
        document.getElementById("registerPasswordConfirm").value = "";
        loginError.textContent = "";
        registerError.textContent = "";
        registerSuccess.textContent = "";
      }

      // Chat szobák betöltése
      function loadRooms() {
        const roomsRef = database.ref("chat/rooms");
        roomsRef.on("value", (snapshot) => {
          roomList.innerHTML = "";

          if (snapshot.exists()) {
            snapshot.forEach((child) => {
              const room = child.val();
              const roomItem = document.createElement("li");

              // DM szoba esetén speciális megjelenítés
              if (child.key.startsWith("dm_")) {
                roomItem.className = "room-item dm-indicator";
                roomItem.innerHTML = `<i class="fas fa-lock"></i> ${room.name || "Privát chat"}`;
              } else {
                roomItem.className = "room-item";
                roomItem.innerHTML = `<i class="fas fa-hashtag"></i> ${room.name}`;
              }

              roomItem.addEventListener("click", () => {
                currentRoom = child.key;
                currentChat.textContent = room.name || "Privát chat";
                loadMessages();
              });
              roomList.appendChild(roomItem);
            });
          }

          // Ha nincsenek szobák
          if (roomList.children.length === 0) {
            roomList.innerHTML =
              '<p style="padding: 1rem; text-align: center; opacity: 0.7;">Még nincsenek szobák. Hozz létre egyet!</p>';
          }
        });
      }

      // Új szoba létrehozása
      async function createRoom() {
        const roomName = roomNameInput.value.trim();
        if (!roomName) return;

        const roomsRef = database.ref("chat/rooms");
        const newRoomRef = roomsRef.push();
        await newRoomRef.set({
          name: roomName,
          createdBy: currentUser.id,
          createdAt: Date.now(),
        });

        closeCreateRoomModal();
      }

      // Felhasználók betöltése
      function loadUsers() {
        const usersRef = database.ref("chat/users");
        usersRef.on("value", (snapshot) => {
          userList.innerHTML = "";

          if (snapshot.exists()) {
            snapshot.forEach((child) => {
              if (child.key !== currentUser.id) {
                const user = child.val();
                const userItem = document.createElement("li");
                userItem.className = "user-item";
                userItem.innerHTML = `<i class="fas fa-user"></i> ${user.username}`;
                userItem.addEventListener("click", () => {
                  // DM indítása a kiválasztott felhasználóval
                  startDM(child.key, user.username);
                });
                userList.appendChild(userItem);
              }
            });
          }
        });
      }

      // Privát üzenet indítása
      function startDM(userId, username) {
        // DM szoba létrehozása vagy betöltése
        const dmId = [currentUser.id, userId].sort().join("_");
        const roomId = `dm_${dmId}`;

        // Ellenőrizzük, hogy létezik-e már a szoba
        const roomRef = database.ref(`chat/rooms/${roomId}`);
        roomRef.once("value").then((snapshot) => {
          if (!snapshot.exists()) {
            // Ha nem létezik, létrehozzuk
            roomRef.set({
              name: `Privát chat: ${currentUser.username} és ${username}`,
              createdBy: currentUser.id,
              createdAt: Date.now(),
              isDM: true,
              participants: {
                [currentUser.id]: true,
                [userId]: true,
              },
            });
          }

          // Beállítjuk az aktuális szobát
          currentRoom = roomId;
          currentChat.textContent = `Privát chat: ${username}`;
          loadMessages();
        });
      }

      // Üzenetek betöltése
      function loadMessages() {
        if (!currentRoom) return;

        const messagesRef = database.ref(`chat/rooms/${currentRoom}/messages`);
        messagesRef.on("value", (snapshot) => {
          messagesContainer.innerHTML = "";

          if (snapshot.exists()) {
            const messages = [];
            snapshot.forEach((child) => {
              messages.push({
                id: child.key,
                ...child.val(),
              });
            });

            // Üzenetek dátum szerinti rendezése
            messages.sort((a, b) => a.timestamp - b.timestamp);

            // Üzenetek megjelenítése
            messages.forEach((message) => {
              const messageElement = document.createElement("div");
              messageElement.className = `message ${message.userId === currentUser.id ? "own" : ""}`;

              const messageTime = new Date(message.timestamp);
              const timeString = messageTime.toLocaleTimeString("hu-HU", {
                hour: "2-digit",
                minute: "2-digit",
              });

              messageElement.innerHTML = `
                            <div class="message-header">
                                <span class="sender">${message.username}</span>
                                <span class="time">${timeString}</span>
                            </div>
                            <div class="message-content">${message.text}</div>
                        `;

              messagesContainer.appendChild(messageElement);
            });

            // Görgetés az aljára
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
          } else {
            // Nincsenek üzenetek
            const noMessages = document.createElement("div");
            noMessages.className = "message";
            noMessages.innerHTML = `
                        <div class="message-content">Még nincsenek üzenetek. Legyél te az első!</div>
                    `;
            messagesContainer.appendChild(noMessages);
          }
        });
      }

      // Üzenet küldése
      function sendMessage() {
        const text = messageInput.value.trim();
        if (!text || !currentRoom) return;

        const messagesRef = database.ref(`chat/rooms/${currentRoom}/messages`);
        const newMessageRef = messagesRef.push();

        newMessageRef.set({
          userId: currentUser.id,
          username: currentUser.username,
          text: text,
          timestamp: Date.now(),
        });

        messageInput.value = "";
      }

      // Eseményfigyelők
      themeToggle.addEventListener("click", toggleTheme);
      logoutBtn.addEventListener("click", logout);

      authTabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          const form = tab.getAttribute("data-form");

          authTabs.forEach((t) => t.classList.remove("active"));
          document
            .querySelectorAll(".auth-form")
            .forEach((f) => f.classList.remove("active"));

          tab.classList.add("active");
          document.getElementById(`${form}Form`).classList.add("active");
        });
      });

      tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          const tabName = tab.getAttribute("data-tab");

          tabs.forEach((t) => t.classList.remove("active"));
          document
            .querySelectorAll(".tab-content")
            .forEach((c) => c.classList.remove("active"));

          tab.classList.add("active");
          document.getElementById(`${tabName}Tab`).classList.add("active");
        });
      });

      loginBtn.addEventListener("click", async () => {
        const email = document.getElementById("loginEmail").value;
        const password = document.getElementById("loginPassword").value;
        const userData = await login(email, password);

        if (userData) {
          setUserSession(userData);
        }
      });

      registerBtn.addEventListener("click", async () => {
        const username = document.getElementById("registerUsername").value;
        const email = document.getElementById("registerEmail").value;
        const password = document.getElementById("registerPassword").value;
        const confirmPassword = document.getElementById(
          "registerPasswordConfirm",
        ).value;

        const userData = await register(
          username,
          email,
          password,
          confirmPassword,
        );

        if (userData) {
          setUserSession(userData);
        }
      });

      sendMessageBtn.addEventListener("click", sendMessage);
      messageInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          sendMessage();
        }
      });

      createRoomBtn.addEventListener("click", openCreateRoomModal);
      confirmCreateRoom.addEventListener("click", createRoom);
      cancelCreateRoom.addEventListener("click", closeCreateRoomModal);
      closeModal.addEventListener("click", closeCreateRoomModal);

      // Modal bezárása overlay-ra kattintva
      createRoomModal.addEventListener("click", (e) => {
        if (e.target === createRoomModal) {
          closeCreateRoomModal();
        }
      });

      // Oldal betöltésekor
      document.addEventListener("DOMContentLoaded", () => {
        updateTheme();

        // Ellenőrizzük, hogy van-e mentett felhasználó
        const savedUser = localStorage.getItem("currentUser");
        if (savedUser) {
          const userData = JSON.parse(savedUser);
          setUserSession(userData);
        }
      });

      // A loadRooms funkció módosítása a privát chatek kezeléséhez
      function loadRooms() {
        const roomsRef = database.ref("chat/rooms");
        roomsRef.on("value", async (snapshot) => {
          roomList.innerHTML = "";

          if (snapshot.exists()) {
            const rooms = [];

            // Első körben gyűjtjük a szobákat
            snapshot.forEach((child) => {
              const room = child.val();
              room.id = child.key;
              rooms.push(room);
            });

            // Szűrjük a privát chateket
            for (const room of rooms) {
              // Közös szobák mindig láthatók
              if (!room.id.startsWith("dm_")) {
                addRoomToList(room);
                continue;
              }

              // Privát chatek: csak a résztvevők láthatják
              if (room.participants && room.participants[currentUser.id]) {
                // Megkeressük a másik résztvevőt
                const otherParticipantId = Object.keys(room.participants).find(
                  (id) => id !== currentUser.id,
                );

                if (otherParticipantId) {
                  // Betöltjük a másik felhasználó adatait
                  const userRef = database.ref(
                    `chat/users/${otherParticipantId}`,
                  );
                  const userSnapshot = await userRef.once("value");

                  if (userSnapshot.exists()) {
                    const otherUser = userSnapshot.val();
                    // Átnevezzük a szobát a másik felhasználó nevére
                    room.name = otherUser.username;
                  }
                }

                addRoomToList(room);
              }
            }
          }

          // Ha nincsenek szobák
          if (roomList.children.length === 0) {
            roomList.innerHTML =
              '<p style="padding: 1rem; text-align: center; opacity: 0.7;">Még nincsenek szobák. Hozz létre egyet!</p>';
          }
        });
      }

      function addRoomToList(room) {
        const roomItem = document.createElement("li");

        // DM szoba esetén speciális megjelenítés
        if (room.id.startsWith("dm_")) {
          roomItem.className = "room-item dm-indicator";
          roomItem.innerHTML = `<i class="fas fa-lock"></i> ${room.name || "Privát chat"}`;
        } else {
          roomItem.className = "room-item";
          roomItem.innerHTML = `<i class="fas fa-hashtag"></i> ${room.name}`;
        }

        roomItem.addEventListener("click", () => {
          currentRoom = room.id;
          currentChat.textContent = room.name || "Privát chat";
          loadMessages();
        });
        roomList.appendChild(roomItem);
      }
    </script>
  </body>
</html>
